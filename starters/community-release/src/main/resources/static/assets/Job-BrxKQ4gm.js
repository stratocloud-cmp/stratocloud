import{_ as ee}from"./StratoTable--zpPaOW_.js";import{d as te,r as ae}from"./job-B1agJq36.js";import{u as le}from"./request-BV6gXtmx.js";import{A as R,n as i,o,q as m,w as t,e,d as g,u as p,a2 as ne,a3 as oe,I as se,t as C,a4 as ie,r as b,b as v,v as T,F as A,f as re,i as F,B as N,x as ue,af as de}from"./index-C_jnbPMf.js";import{d as me}from"./asyncJob-ClCdQ0iF.js";import{_ as ce}from"./StratoDrawer-BQ9z9CYD.js";import"./StratoButton-D7m4JR2l.js";const pe=["innerHTML"],fe={style:{"margin-left":"2px"}},ye={__name:"JobStatus",props:{state:{required:!0},errorMessage:{required:!1},size:{required:!1}},setup(s){const h=s,I={AWAIT_START:{name:"等待",icon:"Clock",type:"info"},STARTED:{name:"已开始",icon:"Loading"},FINISHED:{name:"执行成功",icon:"Check",type:"success"},FAILED:{name:"失败",icon:"Warning",type:"danger"},CANCELED:{name:"已取消",icon:"Close",type:"warning"}},u=R(()=>{let c=I[h.state];return c===void 0&&(c={name:h.state,icon:"QuestionFilled",type:"warning"}),c});return(c,w)=>{const E=i("ElTooltip");return o(),m(p(ie),{size:s.size,type:u.value.type,style:{"font-size":"12px"}},{default:t(()=>[e(E,{disabled:s.state!=="FAILED"},{content:t(()=>[g("div",{style:{"max-width":"500px","white-space":"pre-wrap"},innerHTML:s.errorMessage},null,8,pe)]),default:t(()=>[e(p(ne),{class:oe(u.value.icon==="Loading"?"is-loading":"")},{default:t(()=>[(o(),m(se(u.value.icon)))]),_:1},8,["class"])]),_:1},8,["disabled"]),g("span",fe,C(u.value.name),1)]),_:1},8,["size","type"])}}},_e={style:{"margin-bottom":"10px",height:"32px"}},be={key:0},ge=g("span",{style:{"font-size":"12px"}}," 查看详情 ",-1),we={__name:"Job",props:{simpleMode:{required:!1,type:Boolean,default:!1},myJob:{required:!1,type:Boolean,default:!1}},setup(s,{expose:h}){const I=le(),u=s,c=b();h({refresh:w});function w(){return c.value.fetchData()}const E=b({ownerIds:u.myJob?[I.session.userId]:void 0}),D=b(new Map);function $(n){if(n&&n.length>0){const d=n.map(a=>a.id);me({jobIds:d,size:100}).then(a=>{if(a!=null&&a.content&&a.content.length>0)for(let y of a.content)D.value.set(y.id,y)})}}function H(n){return D.value.has(n)}const S=b(!1);function W(n){f.value=n,S.value=!0}const f=b(),U=R(()=>{if(f.value)return D.value.get(f.value.id)}),L=[{id:"AWAIT_START",name:"待开始",type:"info"},{id:"STARTED",name:"已开始",type:"primary"},{id:"FAILED",name:"已失败",type:"danger"},{id:"FINISHED",name:"已完成",type:"success"},{id:"DISCARDED",name:"已废弃",type:"warning"},{id:"CANCELED",name:"已取消",type:"warning"}],O=L,Q=L;function M(n,d){let a=d.find(y=>y.id===n);return a||(a={id:n,name:n,type:"warning"}),a}const x=b(!1);function G(n){x.value=!0,ae({jobId:n.id}).then(()=>{w(),ue.success("重试请求已提交")}).finally(()=>{x.value=!1})}return(n,d)=>{var B;const a=i("ElTableColumn"),y=i("ElLink"),K=i("ElButton"),r=i("ElTimelineItem"),P=i("ElIcon"),X=i("ElTooltip"),z=i("ElTimeline"),q=i("ElCollapseItem"),V=i("ElCollapse");return o(),v(A,null,[g("div",_e,[u.myJob?(o(),v("span",be,"我的任务")):T("",!0),e(p(re),{style:{float:"right",width:"20%"},modelValue:E.value.search,"onUpdate:modelValue":d[0]||(d[0]=l=>E.value.search=l),"suffix-icon":"search"},null,8,["modelValue"])]),e(ee,{ref_key:"jobTableRef",ref:c,size:s.simpleMode?"small":"default","default-page-size":s.simpleMode?5:10,"paging-request":E.value,"remote-method":p(te),onListChange:$},{default:t(()=>[s.simpleMode?T("",!0):(o(),m(a,{key:0,type:"selection","reserve-selection":""})),e(a,{prop:"jobTypeName",label:"类型",sortable:"custom"}),e(a,{prop:"status",label:"状态",sortable:"custom"},{default:t(l=>[e(ye,{size:u.simpleMode?"small":"default",state:l.row.status,"error-message":l.row.errorMessage},null,8,["size","state","error-message"])]),_:1}),e(a,{prop:"createdAt",label:"创建时间",sortable:"custom"}),e(a,{prop:"startedAt",label:"开始时间",sortable:"custom"}),e(a,{prop:"endedAt",label:"结束时间",sortable:"custom"}),s.simpleMode?T("",!0):(o(),m(a,{key:1,label:"详情",width:"120"},{default:t(l=>[e(y,{type:"primary",disabled:!H(l.row.id),onClick:()=>W(l.row)},{default:t(()=>[ge]),_:2},1032,["disabled","onClick"])]),_:1})),e(a,{label:"操作",width:"80"},{default:t(l=>[e(K,{link:"",type:"primary",loading:x.value,disabled:l.row.status!=="FAILED",onClick:()=>G(l.row)},{default:t(()=>[F(" 重试 ")]),_:2},1032,["loading","disabled","onClick"])]),_:1})]),_:1},8,["size","default-page-size","paging-request","remote-method"]),e(ce,{title:(B=f.value)==null?void 0:B.jobTypeName,modelValue:S.value,"onUpdate:modelValue":d[1]||(d[1]=l=>S.value=l),size:"800","no-confirm":""},{default:t(()=>[e(z,null,{default:t(()=>{var l,j;return[e(r,{timestamp:(l=f.value)==null?void 0:l.startedAt,placement:"top"},null,8,["timestamp"]),(o(!0),v(A,null,N(U.value.executions,(k,Y)=>(o(),m(r,{type:M(k.state,L).type,timestamp:k.lastModifiedAt,placement:"top"},{default:t(()=>[e(V,null,{default:t(()=>[e(q,{title:`执行${Y+1}`},{default:t(()=>[e(z,null,{default:t(()=>[e(r),(o(!0),v(A,null,N(k.steps,(J,Z)=>(o(),m(r,{type:M(J.state,p(O)).type,timestamp:J.lastModifiedAt,placement:"top"},{default:t(()=>[e(V,null,{default:t(()=>[e(q,{title:`步骤${Z+1}`},{default:t(()=>[e(z,null,{default:t(()=>[e(r),(o(!0),v(A,null,N(J.tasks,_=>(o(),m(r,{type:M(_.state,p(Q)).type,timestamp:_.lastModifiedAt,placement:"top"},{default:t(()=>[g("div",null,[F(C(_.name)+" ",1),_.message?(o(),m(X,{key:0},{content:t(()=>[F(C(_.message),1)]),default:t(()=>[e(P,null,{default:t(()=>[e(p(de))]),_:1})]),_:2},1024)):T("",!0)]),g("div",null,C(_.entityDescription),1)]),_:2},1032,["type","timestamp"]))),256)),e(r)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1024)]),_:2},1032,["type","timestamp"]))),256)),e(r)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1024)]),_:2},1032,["type","timestamp"]))),256)),e(r,{timestamp:(j=f.value)==null?void 0:j.endedAt,placement:"top"},null,8,["timestamp"])]}),_:1})]),_:1},8,["title","modelValue"])],64)}}};export{we as default};
