import{s as M,b as O,j as V}from"./resource-ChSpNJ4i.js";import{_ as D}from"./StratoPagingSelector-BVtmGqMc.js";import{A as w,n as b,o as v,b as U,e as T,w as C,u as R,a2 as k,a3 as F,q as x,I as P,d as S,t as E,r as d,a$ as N,aa as _,U as A,a9 as H,ab as G,a7 as K,m as h,Q as W,i as Z}from"./index-CGSAaZ7c.js";import{u as Q}from"./AccountContext-CRGbKwzU.js";import{_ as $}from"./TagValueSelectorGroup-ARuF-rHD.js";import{k as j}from"./IpState-DbETxjvx.js";const z={NO_STATE:{name:"未创建",icon:"Clock",type:"info"},BUILD_ERROR:{name:"创建失败",icon:"Warning",type:"danger"},BUILDING:{name:"正在创建",icon:"Loading",type:"primary"},STARTED:{name:"已启动",icon:"VideoPlay",type:"success"},STOPPING:{name:"正在停止",icon:"Loading",type:"warning"},STOPPED:{name:"已停止",icon:"SwitchButton",type:"danger"},STARTING:{name:"正在启动",icon:"Loading",type:"primary"},RESTARTING:{name:"正在重启",icon:"Loading",type:"primary"},CONFIGURING:{name:"正在配置",icon:"Loading",type:"primary"},SHUTDOWN:{name:"待销毁",icon:"SwitchButton",type:"danger"},DESTROYING:{name:"正在销毁",icon:"Loading",type:"warning"},DESTROYED:{name:"已销毁",icon:"Delete",type:"danger"},ERROR:{name:"错误",icon:"Warning",type:"danger"},LOST:{name:"遗失",icon:"QuestionFilled",type:"warning"},UNKNOWN:{name:"未知",icon:"QuestionFilled",type:"warning"},AVAILABLE:{name:"可用",icon:"CircleCheck",type:"success"},UNAVAILABLE:{name:"不可用",icon:"CircleClose",type:"warning"},SOLD_OUT:{name:"已售罄",icon:"SoldOut",type:"warning"},ATTACHING:{name:"挂载中",icon:"Loading",type:"primary"},DETACHING:{name:"解除挂载中",icon:"Loading",type:"primary"},IN_USE:{name:"使用中",icon:"Connection",type:"warning"},IDLE:{name:"空闲",icon:"CircleCheck",type:"success"},HEALTH_CHECK_NORMAL:{name:"健康检查正常",icon:"CircleCheck",type:"success"},HEALTH_CHECK_ABNORMAL:{name:"健康检查异常",icon:"Warning",type:"error"},HEALTH_CHECK_UNAVAILABLE:{name:"未健康检查",icon:"QuestionFilled",type:"warning"},REBUILDING:{name:"重建中",icon:"Loading",type:"primary"},PAUSED:{name:"已暂停",icon:"SwitchButton",type:"warning"},SUSPENDED:{name:"已挂起",icon:"SwitchButton",type:"warning"},SHELVED:{name:"已搁置",icon:"SwitchButton",type:"warning"},INSUFFICIENT_RESOURCE:{name:"资源紧张",icon:"Warning",type:"warning"}},le={NO_STATE:{name:"未同步",icon:"Clock",type:"info"},OK:{name:"正常",icon:"Check",type:"success"},NOT_FOUND:{name:"资源遗失",icon:"Close",type:"warning"},CONNECTION_ERROR:{name:"平台连接异常",icon:"Warning",type:"warning"}},Y={style:{"margin-left":"6px"}},J={__name:"ResourceState",props:{state:{required:!0}},setup(r){const e=r,t=z,a=w(()=>{let n=t[e.state];return n===void 0&&(n={name:e.state,icon:"QuestionFilled",type:"warning"}),n});return(n,y)=>{const u=b("ElText");return v(),U("span",null,[T(u,{style:{cursor:"pointer"},type:a.value.type},{default:C(()=>[T(R(k),{class:F(a.value.icon==="Loading"?"is-loading":"")},{default:C(()=>[(v(),x(P(a.value.icon)))]),_:1},8,["class"])]),_:1},8,["type"]),S("span",Y,E(a.value.name),1)])}}};function X(r){const e=d();function t(){A(r)&&M({resourceTypeId:A(r)}).then(a=>{var n;if(((n=a.resourceTypes)==null?void 0:n.length)>0)e.value=a.resourceTypes[0];else return Promise.reject("Resource type not found.")})}return N(t),e}class I{constructor(){this.sharedTargetIds=d([]),this.sharedTargetRefCountMap=new Map,this.sharedTargetTypeMap=new Map}getSharedTargetRefCount(e){return this.sharedTargetRefCountMap.has(e)?this.sharedTargetRefCountMap.get(e):0}increaseSharedTargetRefCount(e){if(this.sharedTargetRefCountMap.has(e)){const t=this.sharedTargetRefCountMap.get(e);this.sharedTargetRefCountMap.set(e,t+1)}else this.sharedTargetRefCountMap.set(e,1)}decreaseSharedTargetRefCount(e){if(this.sharedTargetRefCountMap.has(e)){const t=this.sharedTargetRefCountMap.get(e);t>0?this.sharedTargetRefCountMap.set(e,t-1):this.sharedTargetRefCountMap.set(e,0)}this.clearZeroCountSharedTargetIds()}clearZeroCountSharedTargetIds(){this.sharedTargetRefCountMap.forEach((e,t)=>{(e===void 0||e===0)&&this.removeSharedTargetId(t)})}removeSharedTargetId(e){const t=this.sharedTargetIds.value.indexOf(e);t>=0&&this.sharedTargetIds.value.splice(t,1),this.sharedTargetTypeMap.delete(e)}addSharedTargetId(e,t){this.sharedTargetIds.value.indexOf(e)<0&&this.sharedTargetIds.value.push(e),this.sharedTargetTypeMap.set(e,t),this.increaseSharedTargetRefCount(e)}getTargetIdsByType(e){const t=[];return this.sharedTargetTypeMap.forEach((a,n)=>{a===e&&t.push(n)}),t}setAllTargetIdsZeroByType(e,t){this.getTargetIdsByType(e).filter(n=>t!==n).forEach(n=>this.sharedTargetRefCountMap.set(n,0)),this.clearZeroCountSharedTargetIds()}}function ee(){return new I}function de(){const r=new I;return H("resourceContext",r),r}function te(r,e){const t=_("resourceContext",new I),a=d([]);function n(){var y;if(!e.value){a.value.forEach(u=>t.decreaseSharedTargetRefCount(u)),a.value=[];return}if(r.value&&!(((y=r.value.requirements)==null?void 0:y.length)<=0))for(let u of r.value.requirements)u.targetSpec.sharedRequirementTarget&&O({sourceId:e.value,relationshipType:u.relationshipSpec.relationshipTypeId,size:100}).then(g=>{if(!g.content)return;const l=[];for(let i of g.content){const m=t.getTargetIdsByType(i.target.type);m.length>0&&!m.some(p=>p===i.target.id)||l.push(i)}for(let i of l)a.value.push(i.target.id),t.addSharedTargetId(i.target.id,i.target.type)})}return N(n),t}function pe(r,e){const t=_("resourceContext",new I),a=d();function n(){r.value&&(e.value?a.value||(a.value=e.value,t.setAllTargetIdsZeroByType(r.value.spec.resourceTypeId,e.value),t.addSharedTargetId(e.value,r.value.spec.resourceTypeId)):a.value&&(t.decreaseSharedTargetRefCount(a.value),a.value=void 0))}return N(n),t}const ae={style:{float:"left"}},re={style:{float:"right",color:"grey"}},ge={__name:"ResourceSelector",props:G({resourceTypeId:{required:!1},resourceCategory:{required:!1},resourceTags:{required:!1,default:[]},contextConsumer:{required:!1,type:Function,default:te},placeholder:{required:!1,default:"请选择资源"},disabledFlagGetter:{required:!1,type:Function,default:r=>r.recycled},multiple:{required:!1,type:Boolean,default:!1},ipPoolAttachable:{required:!1,type:Boolean,default:void 0},teleported:{required:!1,default:!0,type:Boolean},isolatedResourceContext:{required:!1,default:!1,type:Boolean}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(r,{expose:e}){const t=r,a=X(()=>t.resourceTypeId),n=K(r,"modelValue"),u=(t.isolatedResourceContext?ee():t.contextConsumer(a,n)).sharedTargetIds,g=d(),l=Q(g),i=j(),m=d(!1),p=d({requirementTargetIds:u.value,resourceCategories:t.resourceCategory?[t.resourceCategory]:void 0,resourceTypes:t.resourceTypeId?[t.resourceTypeId]:void 0,accountIds:l.accountId.value?[l.accountId.value]:void 0,ipPoolAttachable:t.ipPoolAttachable});h(n,()=>{a.value&&a.value.spec.canAttachIpPool&&(i.networkResourceId.value=n.value)}),h(u,()=>{p.value.requirementTargetIds=u.value},{deep:!0}),h(l.accountId,()=>{p.value.accountIds=l.accountId.value?[l.accountId.value]:void 0}),h(()=>t.resourceTypeId,()=>{p.value.resourceTypes=t.resourceTypeId?[t.resourceTypeId]:void 0});function B(){var o;return(o=a.value)==null?void 0:o.spec.resourceCategoryName}function L(o){if(!o){g.value=void 0,f.value.forEach(s=>{s.tagValue=void 0,s.tagValueName=void 0});return}g.value=o.accountId,o.tags&&(f.value=o.tags)}e({getCategoryName:B});const f=d([]),q=w(()=>{var o;return{requiredWhenFiltering:!0,resourceCategories:[(o=a.value)==null?void 0:o.spec.resourceCategoryId]}});return h(f,()=>{const o={};f.value.forEach(s=>{!s.tagKey||!s.tagValue||(o[s.tagKey]||(o[s.tagKey]=[]),o[s.tagKey].push(s.tagValue))}),p.value.tagsMap=o},{deep:!0}),(o,s)=>(v(),x(D,{modelValue:n.value,"onUpdate:modelValue":s[1]||(s[1]=c=>n.value=c),disabled:m.value,"paging-request":p.value,"label-getter":c=>c.name,"remote-method":R(V),"disabled-option-flag-getter":r.disabledFlagGetter,onChange:L,placeholder:r.placeholder,multiple:r.multiple,teleported:r.teleported,"sorted-by":"recycled",direction:"ASC","id-filter-key":"resourceIds"},W({default:C(c=>[S("span",ae,E(c.row.name),1),S("span",re,[T(J,{state:c.row.state},null,8,["state"]),Z("   "+E(c.row.typeName),1)])]),_:2},[R(a)?{name:"header",fn:C(()=>[T($,{"entry-paging-request":q.value,modelValue:f.value,"onUpdate:modelValue":s[0]||(s[0]=c=>f.value=c)},null,8,["entry-paging-request","modelValue"])]),key:"0"}:void 0]),1032,["modelValue","disabled","paging-request","label-getter","remote-method","disabled-option-flag-getter","placeholder","multiple","teleported"]))}};export{le as R,J as _,z as a,ge as b,de as c,pe as d,X as u};
