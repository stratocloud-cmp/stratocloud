import{o as M,b as O,j as V}from"./resource-DdTtSOFP.js";import{_ as D}from"./StratoPagingSelector-BY9rDrJk.js";import{A as x,o as I,q as R,w as y,e as S,u as C,a2 as b,a3 as U,I as k,d as E,t as N,a4 as F,r as p,aq as A,ab as q,W as w,aa as P,ac as H,a8 as G,m as h,Q as K,i as W}from"./index-C_jnbPMf.js";import{u as Z}from"./AccountContext-Bp4LXd0C.js";import{_ as Q}from"./TagValueSelectorGroup-kSkYehu4.js";import{k as $}from"./IpState-yQwbBpiP.js";const j={NO_STATE:{name:"未创建",icon:"Clock",type:"info"},BUILD_ERROR:{name:"创建失败",icon:"Warning",type:"danger"},BUILDING:{name:"正在创建",icon:"Loading"},STARTED:{name:"已启动",icon:"VideoPlay",type:"success"},STOPPING:{name:"正在停止",icon:"Loading",type:"warning"},STOPPED:{name:"已停止",icon:"SwitchButton",type:"danger"},STARTING:{name:"正在启动",icon:"Loading"},RESTARTING:{name:"正在重启",icon:"Loading"},CONFIGURING:{name:"正在配置",icon:"Loading"},SHUTDOWN:{name:"待销毁",icon:"SwitchButton",type:"danger"},DESTROYING:{name:"正在销毁",icon:"Loading",type:"warning"},DESTROYED:{name:"已销毁",icon:"Delete",type:"danger"},ERROR:{name:"错误",icon:"Warning",type:"danger"},LOST:{name:"遗失",icon:"QuestionFilled",type:"warning"},UNKNOWN:{name:"未知",icon:"QuestionFilled",type:"warning"},AVAILABLE:{name:"可用",icon:"CircleCheck",type:"success"},UNAVAILABLE:{name:"不可用",icon:"CircleClose",type:"warning"},SOLD_OUT:{name:"已售罄",icon:"SoldOut",type:"warning"},ATTACHING:{name:"挂载中",icon:"Loading"},DETACHING:{name:"解除挂载中",icon:"Loading"},IN_USE:{name:"使用中",icon:"Connection",type:"warning"},IDLE:{name:"空闲",icon:"CircleCheck",type:"success"},HEALTH_CHECK_NORMAL:{name:"健康检查正常",icon:"CircleCheck",type:"success"},HEALTH_CHECK_ABNORMAL:{name:"健康检查异常",icon:"Warning",type:"error"},HEALTH_CHECK_UNAVAILABLE:{name:"未健康检查",icon:"QuestionFilled",type:"warning"},REBUILDING:{name:"重建中",icon:"Loading"},PAUSED:{name:"已暂停",icon:"SwitchButton",type:"warning"},SUSPENDED:{name:"已挂起",icon:"SwitchButton",type:"warning"},SHELVED:{name:"已搁置",icon:"SwitchButton",type:"warning"},INSUFFICIENT_RESOURCE:{name:"资源紧张",icon:"Warning",type:"warning"}},ce={NO_STATE:{name:"未同步",icon:"Clock",type:"info"},OK:{name:"正常",icon:"Check",type:"success"},NOT_FOUND:{name:"资源遗失",icon:"Close",type:"warning"},CONNECTION_ERROR:{name:"平台连接异常",icon:"Warning",type:"warning"}},z={style:{"margin-left":"2px"}},Y={__name:"ResourceState",props:{state:{required:!0}},setup(r){const t=r,e=j,n=x(()=>{let a=e[t.state];return a===void 0&&(a={name:t.state,icon:"QuestionFilled",type:"warning"}),a});return(a,T)=>(I(),R(C(F),{type:n.value.type,style:{"font-size":"12px"}},{default:y(()=>[S(C(b),{class:U(n.value.icon==="Loading"?"is-loading":"")},{default:y(()=>[(I(),R(k(n.value.icon)))]),_:1},8,["class"]),E("span",z,N(n.value.name),1)]),_:1},8,["type"]))}};function J(r){const t=p();function e(){w(r)&&M({resourceTypeId:w(r)}).then(n=>{var a;if(((a=n.resourceTypes)==null?void 0:a.length)>0)t.value=n.resourceTypes[0];else return Promise.reject("Resource type not found.")})}return A(e),t}class v{constructor(){this.sharedTargetIds=p([]),this.sharedTargetRefCountMap=new Map,this.sharedTargetTypeMap=new Map}getSharedTargetRefCount(t){return this.sharedTargetRefCountMap.has(t)?this.sharedTargetRefCountMap.get(t):0}increaseSharedTargetRefCount(t){if(this.sharedTargetRefCountMap.has(t)){const e=this.sharedTargetRefCountMap.get(t);this.sharedTargetRefCountMap.set(t,e+1)}else this.sharedTargetRefCountMap.set(t,1)}decreaseSharedTargetRefCount(t){if(this.sharedTargetRefCountMap.has(t)){const e=this.sharedTargetRefCountMap.get(t);e>0?this.sharedTargetRefCountMap.set(t,e-1):this.sharedTargetRefCountMap.set(t,0)}this.clearZeroCountSharedTargetIds()}clearZeroCountSharedTargetIds(){this.sharedTargetRefCountMap.forEach((t,e)=>{(t===void 0||t===0)&&this.removeSharedTargetId(e)})}removeSharedTargetId(t){const e=this.sharedTargetIds.value.indexOf(t);e>=0&&this.sharedTargetIds.value.splice(e,1),this.sharedTargetTypeMap.delete(t)}addSharedTargetId(t,e){this.sharedTargetIds.value.indexOf(t)<0&&this.sharedTargetIds.value.push(t),this.sharedTargetTypeMap.set(t,e),this.increaseSharedTargetRefCount(t)}getTargetIdsByType(t){const e=[];return this.sharedTargetTypeMap.forEach((n,a)=>{n===t&&e.push(a)}),e}setAllTargetIdsZeroByType(t,e){this.getTargetIdsByType(t).filter(a=>e!==a).forEach(a=>this.sharedTargetRefCountMap.set(a,0)),this.clearZeroCountSharedTargetIds()}}function X(){return new v}function le(){const r=new v;return P("resourceContext",r),r}function ee(r,t){const e=q("resourceContext",new v),n=p([]);function a(){var T;if(!t.value){n.value.forEach(c=>e.decreaseSharedTargetRefCount(c)),n.value=[];return}if(r.value&&!(((T=r.value.requirements)==null?void 0:T.length)<=0))for(let c of r.value.requirements)c.targetSpec.sharedRequirementTarget&&O({sourceId:t.value,relationshipType:c.relationshipSpec.relationshipTypeId,size:100}).then(g=>{if(!g.content)return;const l=[];for(let u of g.content){const m=e.getTargetIdsByType(u.target.type);m.length>0&&!m.some(d=>d===u.target.id)||l.push(u)}for(let u of l)n.value.push(u.target.id),e.addSharedTargetId(u.target.id,u.target.type)})}return A(a),e}function de(r,t){const e=q("resourceContext",new v),n=p();function a(){r.value&&(t.value?n.value||(n.value=t.value,e.setAllTargetIdsZeroByType(r.value.spec.resourceTypeId,t.value),e.addSharedTargetId(t.value,r.value.spec.resourceTypeId)):n.value&&(e.decreaseSharedTargetRefCount(n.value),n.value=void 0))}return A(a),e}const te={style:{float:"left"}},ae={style:{float:"right",color:"grey"}},pe={__name:"ResourceSelector",props:H({resourceTypeId:{required:!1},resourceCategory:{required:!1},resourceTags:{required:!1,default:[]},contextConsumer:{required:!1,type:Function,default:ee},placeholder:{required:!1,default:"请选择资源"},disabledFlagGetter:{required:!1,type:Function,default:r=>r.recycled},multiple:{required:!1,type:Boolean,default:!1},ipPoolAttachable:{required:!1,type:Boolean,default:void 0},teleported:{required:!1,default:!1,type:Boolean},isolatedResourceContext:{required:!1,default:!1,type:Boolean}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(r,{expose:t}){const e=r,n=J(()=>e.resourceTypeId),a=G(r,"modelValue"),c=(e.isolatedResourceContext?X():e.contextConsumer(n,a)).sharedTargetIds,g=p(),l=Z(g),u=$(),m=p(!1),d=p({requirementTargetIds:c.value,resourceCategories:e.resourceCategory?[e.resourceCategory]:void 0,resourceTypes:e.resourceTypeId?[e.resourceTypeId]:void 0,accountIds:l.accountId.value?[l.accountId.value]:void 0,resourceIds:e.multiple?a.value:a.value?[a.value]:void 0,ipPoolAttachable:e.ipPoolAttachable});h(a,()=>{d.value.resourceIds=e.multiple?void 0:a.value?[a.value]:void 0,n.value&&n.value.spec.canAttachIpPool&&(u.networkResourceId.value=a.value)}),h(c,()=>{d.value.requirementTargetIds=c.value},{deep:!0}),h(l.accountId,()=>{d.value.accountIds=l.accountId.value?[l.accountId.value]:void 0}),h(()=>e.resourceTypeId,()=>{d.value.resourceTypes=e.resourceTypeId?[e.resourceTypeId]:void 0});function L(){var o;return(o=n.value)==null?void 0:o.spec.resourceCategoryName}function _(o){if(!o){g.value=void 0,f.value.forEach(s=>{s.tagValue=void 0,s.tagValueName=void 0});return}g.value=o.accountId,o.tags&&(f.value=o.tags)}t({getCategoryName:L});const f=p([]),B=x(()=>{var o;return{requiredWhenFiltering:!0,resourceCategories:[(o=n.value)==null?void 0:o.spec.resourceCategoryId]}});return h(f,()=>{const o={};f.value.forEach(s=>{!s.tagKey||!s.tagValue||(o[s.tagKey]||(o[s.tagKey]=[]),o[s.tagKey].push(s.tagValue))}),d.value.tagsMap=o},{deep:!0}),(o,s)=>(I(),R(D,{modelValue:a.value,"onUpdate:modelValue":s[1]||(s[1]=i=>a.value=i),disabled:m.value,"paging-request":d.value,"label-getter":i=>i.name,"remote-method":C(V),"disabled-option-flag-getter":r.disabledFlagGetter,onChange:_,placeholder:r.placeholder,multiple:r.multiple,teleported:r.teleported,"sorted-by":"recycled",direction:"ASC"},K({default:y(i=>[E("span",te,N(i.row.name),1),E("span",ae,[S(Y,{state:i.row.state},null,8,["state"]),W("   "+N(i.row.typeName),1)])]),_:2},[C(n)?{name:"header",fn:y(()=>[S(Q,{"entry-paging-request":B.value,modelValue:f.value,"onUpdate:modelValue":s[0]||(s[0]=i=>f.value=i)},null,8,["entry-paging-request","modelValue"])]),key:"0"}:void 0]),1032,["modelValue","disabled","paging-request","label-getter","remote-method","disabled-option-flag-getter","placeholder","multiple","teleported"]))}};export{ce as R,Y as _,j as a,pe as b,le as c,de as d,J as u};
