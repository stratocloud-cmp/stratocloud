import{_ as J}from"./StratoTable-EZs1qWj6.js";import{S as P}from"./StratoButton-BRlR7RNE.js";import{_ as q}from"./StratoDrawer-i3nJdUbZ.js";import{a as A,c as L,u as H,b as X,d as Y}from"./workflow-DYymCifP.js";import{T as j,S as Q,a as Z,K as ee,C as te,H as oe,G as K,b as ne,E as le,D as R,u as ae}from"./SequenceGenerator-BF8TOZ3E.js";import{_ as re}from"./StratoDynamicForm-Bd91LD1B.js";import{a7 as se,r as p,n as F,o as _,q as S,w as i,e as r,v as I,y as de,m as ie,b as O,d as k,i as N,F as G,u as b,O as ue,f as ce,P as x}from"./index-CJwSUwqU.js";import"./request-IeLrxslB.js";import"./IpState-C6MgozXE.js";import"./UserSelector-CoJSGQ4A.js";import"./StratoPagingSelector-DNkLqj4O.js";import"./user-Ce1W_vfQ.js";import"./role-DMNZ0gjB.js";import"./job-P3tzUzyD.js";import"./scriptDefinition-YE6MXqAV.js";function me(e,t){const n=he(t);n.use(new j({resizing:!0,rotating:!0})).use(new Q({rubberband:!1,showNodeSelectionBox:!0})).use(new Z).use(new ee).use(new te).use(new oe);const a=we(n,e);ye(n);const l=ge(n);return pe(l,n,a),n}function fe(e){const t=new R({nodesep:20,ranksep:20}),n=e.toJSON();console.log(n);const a={edges:[],nodes:[]};n.cells.forEach(s=>{s.shape==="edge"?a.edges.push(s):a.nodes.push(s)});const l=t.layout(a);console.log(l),e.fromJSON(l)}function pe(e,t,n){K.registerNode("custom-rect",{inherit:"rect",width:80,height:36,attrs:{body:{strokeWidth:1,stroke:"#5F95FF",fill:"#EFF4FF"},text:{fontSize:12,fill:"#262626"}},ports:{...e}},!0),K.registerNode("custom-polygon",{inherit:"polygon",width:66,height:36,attrs:{body:{strokeWidth:1,stroke:"#5F95FF",fill:"#EFF4FF"},text:{fontSize:12,fill:"#262626"}},ports:{...e,items:[{group:"top"},{group:"bottom"}]}},!0),K.registerNode("custom-circle",{inherit:"circle",width:45,height:45,attrs:{body:{strokeWidth:1,stroke:"#5F95FF",fill:"#EFF4FF"},text:{fontSize:12,fill:"#262626"}},ports:{...e}},!0),K.registerNode("custom-image",{inherit:"rect",width:52,height:52,markup:[{tagName:"rect",selector:"body"},{tagName:"image"},{tagName:"text",selector:"label"}],attrs:{body:{stroke:"#5F95FF",fill:"#5F95FF"},image:{width:26,height:26,refX:13,refY:16},label:{refX:3,refY:2,textAnchor:"left",textVerticalAnchor:"top",fontSize:12,fill:"#fff"}},ports:{...e}},!0);const a=[];A({}).then(l=>{for(let s of l.nodeTypes){const y={nodeType:s.nodeType,nodeTypeName:s.nodeTypeName,nodePropertiesFormMetaData:s.nodePropertiesFormMetaData,nodeProperties:{}};a.push({shape:"custom-rect",label:s.nodeTypeName,data:y,attrs:{body:{rx:10,ry:10}}})}n.load(a,"group1")})}function ye(e){e.bindKey(["meta+c","ctrl+c"],()=>{const t=e.getSelectedCells();return t.length&&e.copy(t),!1}),e.bindKey(["meta+x","ctrl+x"],()=>{const t=e.getSelectedCells();return t.length&&e.cut(t),!1}),e.bindKey(["meta+v","ctrl+v"],()=>{if(!e.isClipboardEmpty()){const t=e.paste({offset:32});e.cleanSelection(),e.select(t)}return!1}),e.bindKey(["meta+z","ctrl+z"],()=>(e.canUndo()&&e.undo(),!1)),e.bindKey(["meta+shift+z","ctrl+shift+z"],()=>(e.canRedo()&&e.redo(),!1)),e.bindKey(["meta+a","ctrl+a"],()=>{const t=e.getNodes();t&&e.select(t)}),e.bindKey("backspace",()=>{const t=e.getSelectedCells();t.length&&e.removeCells(t)})}function ge(e){const t=(n,a)=>{for(let l=0,s=n.length;l<s;l+=1)n[l].style.visibility=a?"visible":"hidden"};return e.on("node:mouseenter",()=>{const a=document.getElementById(e.container.id).querySelectorAll(".x6-port-body");t(a,!0)}),e.on("node:mouseleave",()=>{const a=document.getElementById(e.container.id).querySelectorAll(".x6-port-body");t(a,!1)}),{groups:{top:{position:"top",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},right:{position:"right",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},bottom:{position:"bottom",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},left:{position:"left",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}}},items:[{group:"top"},{group:"right"},{group:"bottom"},{group:"left"}]}}function we(e,t){const n=new ne({title:"流程图",target:e,stencilGraphWidth:120,collapsable:!0,groups:[{title:"节点列表",name:"group1",collapsable:!0}],stencilGraphHeight:300,layoutOptions:{columns:1,columnWidth:100,rowHeight:55}});return document.getElementById(t).appendChild(n.container),n}function he(e){return new K({container:document.getElementById(e),width:"100%",height:"100%",grid:!0,panning:!0,connecting:{router:"manhattan",connector:{name:"rounded",args:{radius:8}},anchor:"center",connectionPoint:"anchor",allowBlank:!1,snap:{radius:20},createEdge(){return new le({attrs:{line:{stroke:"#A2B1C3",strokeWidth:2,targetMarker:{name:"block",width:12,height:8}}},zIndex:0})},validateConnection({targetMagnet:t}){return!!t}},highlighting:{magnetAdsorbed:{name:"stroke",args:{attrs:{fill:"#5F95FF",stroke:"#5F95FF"}}}}})}const ke={__name:"WorkflowNodeForm",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(e){const t=se(e,"modelValue"),n=p();return(a,l)=>{const s=F("ElInput"),y=F("ElFormItem"),V=F("ElForm");return _(),S(V,{size:"small",ref_key:"formRef",ref:n,model:t.value,"label-position":"top"},{default:i(()=>[r(y,{label:"节点类型"},{default:i(()=>[r(s,{disabled:"",modelValue:t.value.nodeType,"onUpdate:modelValue":l[0]||(l[0]=m=>t.value.nodeType=m)},null,8,["modelValue"])]),_:1}),r(y,{label:"节点类型名称"},{default:i(()=>[r(s,{disabled:"",modelValue:t.value.nodeTypeName,"onUpdate:modelValue":l[1]||(l[1]=m=>t.value.nodeTypeName=m)},null,8,["modelValue"])]),_:1}),r(y,{label:"节点标识"},{default:i(()=>[r(s,{disabled:"",modelValue:t.value.nodeKey,"onUpdate:modelValue":l[2]||(l[2]=m=>t.value.nodeKey=m)},null,8,["modelValue"])]),_:1}),r(y,{label:"节点名称"},{default:i(()=>[r(s,{modelValue:t.value.nodeName,"onUpdate:modelValue":l[3]||(l[3]=m=>t.value.nodeName=m)},null,8,["modelValue"])]),_:1}),t.value.nodePropertiesFormMetaData?(_(),S(re,{key:0,size:"small","form-meta-data":t.value.nodePropertiesFormMetaData,modelValue:t.value.nodeProperties,"onUpdate:modelValue":l[4]||(l[4]=m=>t.value.nodeProperties=m)},null,8,["form-meta-data","modelValue"])):I("",!0)]),_:1},8,["model"])}}},ve={style:{height:"10%"}},be=k("div",null,[N(" 从左侧面板拖拽出节点放置到右侧画布上，鼠标悬停于节点上将显示连接桩(节点边缘的小圆圈)， 点击连接桩(按住鼠标左键)拖出线条进行连线，连接完成后松开鼠标左键。"),k("br"),N(" 可点击某个节点以修改其属性。"),k("br"),N(" 快捷键：ctrl+c复制，ctrl+v粘贴，ctrl+x剪切，backspace删除，ctrl+z撤销，ctrl+shift+z重做，ctrl+a全选 ")],-1),Fe="workflow-main-container",B="workflow-stencil-container",M="workflow-graph-container",U={__name:"WorkflowEditor",props:{workflow:{required:!1}},setup(e,{expose:t}){const n=e,a=ae();let l;de(()=>{l=me(B,M),l.on("node:added",({node:o})=>m(o)),l.on("node:click",({node:o})=>D(o)),l.on("cell:mouseenter",({cell:o})=>V(o)),l.on("cell:mouseleave",({cell:o})=>{o.removeTool("button-remove")}),n.workflow&&s()});async function s(){g.value.workflowName=n.workflow.name;const o=await A({}).then(c=>c.nodeTypes),d={nodes:[],edges:[]};for(let c of n.workflow.nodes){a.addSequence(c.nodeKey),a.addSequence(c.nodeName);const T=o.find($=>c.nodeType===$.nodeType),h={nodeType:T.nodeType,nodeTypeName:T.nodeTypeName,nodePropertiesFormMetaData:T.nodePropertiesFormMetaData,nodeKey:c.nodeKey,nodeName:c.nodeName,nodeProperties:c.nodeProperties};d.nodes.push({id:h.nodeKey,shape:"custom-rect",label:h.nodeName,data:h,attrs:{body:{rx:10,ry:10}},ports:{items:[{group:"top",id:h.nodeKey+"-top"},{group:"right",id:h.nodeKey+"-right"},{group:"bottom",id:h.nodeKey+"-bottom"},{group:"left",id:h.nodeKey+"-left"}]}})}for(let c of n.workflow.sequenceFlows)d.edges.push({shape:"edge",source:{cell:c.sourceNodeKey,port:c.sourceNodeKey+"-bottom"},target:{cell:c.targetNodeKey,port:c.targetNodeKey+"-top"},attrs:{line:{stroke:"#A2B1C3",strokeWidth:2,targetMarker:{name:"block",width:12,height:8}}},zIndex:0});const f=new R({nodesep:20,ranksep:20}).layout(d);l.fromJSON(f)}function y(){fe(l)}function V(o){o.addTools([{name:"button-remove"}])}function m(o){if(o.data.nodeKey!==o.id){const d=a.getSequence(o.getData().nodeTypeName),u=a.getSequence(o.getData().nodeType);o.label=d,o.updateData({nodeName:d,nodeKey:u})}}const E=p(),v=p();function D(o){E.value=o,v.value=o.data}ie(()=>{var o;return(o=v.value)==null?void 0:o.nodeName},()=>{var o;(o=v.value)!=null&&o.nodeName&&(E.value.label=v.value.nodeName)});const g=p({});function C(o,d){return o.find(u=>u.id===d)}function W(){var d,u;const o=l.toJSON();g.value.nodes=[],g.value.sequenceFlows=[];for(let f of o.cells)f.shape==="edge"?g.value.sequenceFlows.push({sourceNodeKey:(d=C(o.cells,f.source.cell))==null?void 0:d.data.nodeKey,targetNodeKey:(u=C(o.cells,f.target.cell))==null?void 0:u.data.nodeKey}):g.value.nodes.push({nodeType:f.data.nodeType,nodeKey:f.data.nodeKey,nodeName:f.data.nodeName,nodeProperties:f.data.nodeProperties})}function z(){return W(),L(g.value)}function w(){if(!n.workflow){console.error("Current workflow is undefined, cannot update.");return}W();const o={...g.value,workflowId:n.workflow.id};return H(o)}return t({confirmCreate:z,confirmUpdate:w}),(o,d)=>{const u=F("ElInput"),f=F("ElButton"),c=F("ElTooltip"),T=F("ElCard");return _(),O(G,null,[k("div",ve,[r(u,{style:{width:"150px","margin-right":"50px"},modelValue:g.value.workflowName,"onUpdate:modelValue":d[0]||(d[0]=h=>g.value.workflowName=h),placeholder:"请输入流程名称"},null,8,["modelValue"]),r(f,{onClick:y},{default:i(()=>[N("自动布局")]),_:1}),r(c,null,{content:i(()=>[be]),default:i(()=>[r(f,{link:"",icon:"Warning"},{default:i(()=>[N("操作说明")]),_:1})]),_:1}),E.value?(_(),S(T,{style:{position:"absolute",top:"80px",right:"30px",width:"260px","background-color":"#07070e","z-index":"9999"},key:E.value.label},{default:i(()=>[r(ke,{modelValue:v.value,"onUpdate:modelValue":d[1]||(d[1]=h=>v.value=h)},null,8,["modelValue"])]),_:1})):I("",!0)]),k("div",{style:{width:"100%",height:"90%"}},[k("div",{id:Fe},[k("div",{id:B}),k("div",{id:M})])])],64)}}},Ne={style:{"margin-bottom":"10px",height:"32px"}},Me={__name:"Workflow",setup(e){const t=p(),n=p(!1),a=p(!1),l=p([]),s=p({}),y=p();function V(w){l.value=w}function m(){return l.value.map(w=>w.id)}function E(){n.value=!0}function v(w){y.value=w,a.value=!0}const D=p();function g(){D.value.confirmCreate().then(w=>{n.value=!1,t.value.fetchData()})}const C=p();function W(){C.value.confirmUpdate().then(w=>{a.value=!1,t.value.fetchData()})}function z(){const o={workflowIds:m()};X(o).then(d=>{t.value.fetchData()})}return(w,o)=>{const d=F("ElButton");return _(),O(G,null,[k("div",Ne,[r(P,{type:"primary",onClick:E},{default:i(()=>[N(" 创建 ")]),_:1}),r(b(ue),{title:"确认删除",onConfirm:z},{reference:i(()=>[r(P,{disabled:l.value.length===0,type:"danger",plain:""},{default:i(()=>[N(" 删除 ")]),_:1},8,["disabled"])]),_:1}),r(b(ce),{style:{float:"right",width:"20%"},modelValue:s.value.search,"onUpdate:modelValue":o[0]||(o[0]=u=>s.value.search=u),"suffix-icon":"search"},null,8,["modelValue"])]),r(J,{ref_key:"tableRef",ref:t,"paging-request":s.value,"remote-method":b(Y),onSelectionChange:V},{default:i(()=>[r(b(x),{type:"selection","reserve-selection":""}),r(b(x),{prop:"name",label:"名称",sortable:"custom"}),r(b(x),{prop:"createdAt",label:"创建时间",sortable:"custom"}),r(b(x),{prop:"lastModifiedAt",label:"更新时间",sortable:"custom"}),r(b(x),{width:"100"},{default:i(u=>[r(d,{link:"",type:"primary",onClick:()=>v(u.row)},{default:i(()=>[N(" 编辑 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["paging-request","remote-method"]),r(q,{modelValue:n.value,"onUpdate:modelValue":o[1]||(o[1]=u=>n.value=u),title:"创建流程",onOnConfirm:g,size:"1000"},{default:i(()=>[n.value?(_(),S(U,{key:0,ref_key:"createEditorRef",ref:D},null,512)):I("",!0)]),_:1},8,["modelValue"]),r(q,{modelValue:a.value,"onUpdate:modelValue":o[2]||(o[2]=u=>a.value=u),title:"编辑流程",onOnConfirm:W,size:"1000"},{default:i(()=>[a.value?(_(),S(U,{key:0,ref_key:"updateEditorRef",ref:C,workflow:y.value},null,8,["workflow"])):I("",!0)]),_:1},8,["modelValue"])],64)}}};export{Me as default};
