import{_ as J}from"./StratoTable--zpPaOW_.js";import{S as q}from"./StratoButton-D7m4JR2l.js";import{_ as P}from"./StratoDrawer-BQ9z9CYD.js";import{a as A,c as L,u as H,b as X,d as Y}from"./workflow-CLa2u6qS.js";import{T as j,S as Q,o as Z,K as ee,p as te,H as oe,j as x,q as ne,s as le,D as R,u as ae}from"./index-6Zsesv0K.js";import{_ as re}from"./StratoDynamicForm-BeoKTVDl.js";import{a8 as se,r as f,n as N,o as _,q as K,w as i,e as r,v as I,y as de,m as ie,b as O,d as v,i as k,F as G,u as F,O as ue,f as ce,P as W}from"./index-C_jnbPMf.js";import"./request-BV6gXtmx.js";import"./IpState-yQwbBpiP.js";import"./UserSelector-Bks_jgjv.js";import"./StratoPagingSelector-BY9rDrJk.js";import"./user-BKxh-AQB.js";import"./role-DAS94606.js";import"./job-B1agJq36.js";import"./scriptDefinition-BwQHe3UI.js";function me(e,t){const l=he(t);l.use(new j({resizing:!0,rotating:!0})).use(new Q({rubberband:!1,showNodeSelectionBox:!0})).use(new Z).use(new ee).use(new te).use(new oe);const a=we(l,e);ye(l);const n=ge(l);return pe(n,l,a),l}function fe(e){const t=new R({nodesep:20,ranksep:20}),l=e.toJSON();console.log(l);const a={edges:[],nodes:[]};l.cells.forEach(d=>{d.shape==="edge"?a.edges.push(d):a.nodes.push(d)});const n=t.layout(a);console.log(n),e.fromJSON(n)}function pe(e,t,l){x.registerNode("custom-rect",{inherit:"rect",width:80,height:36,attrs:{body:{strokeWidth:1,stroke:"#5F95FF",fill:"#EFF4FF"},text:{fontSize:12,fill:"#262626"}},ports:{...e}},!0),x.registerNode("custom-polygon",{inherit:"polygon",width:66,height:36,attrs:{body:{strokeWidth:1,stroke:"#5F95FF",fill:"#EFF4FF"},text:{fontSize:12,fill:"#262626"}},ports:{...e,items:[{group:"top"},{group:"bottom"}]}},!0),x.registerNode("custom-circle",{inherit:"circle",width:45,height:45,attrs:{body:{strokeWidth:1,stroke:"#5F95FF",fill:"#EFF4FF"},text:{fontSize:12,fill:"#262626"}},ports:{...e}},!0),x.registerNode("custom-image",{inherit:"rect",width:52,height:52,markup:[{tagName:"rect",selector:"body"},{tagName:"image"},{tagName:"text",selector:"label"}],attrs:{body:{stroke:"#5F95FF",fill:"#5F95FF"},image:{width:26,height:26,refX:13,refY:16},label:{refX:3,refY:2,textAnchor:"left",textVerticalAnchor:"top",fontSize:12,fill:"#fff"}},ports:{...e}},!0);const a=[];A({}).then(n=>{for(let d of n.nodeTypes){const p={nodeType:d.nodeType,nodeTypeName:d.nodeTypeName,nodePropertiesFormMetaData:d.nodePropertiesFormMetaData,nodeProperties:{}};a.push({shape:"custom-rect",label:d.nodeTypeName,data:p,attrs:{body:{rx:10,ry:10}}})}l.load(a,"group1")})}function ye(e){e.bindKey(["meta+c","ctrl+c"],()=>{const t=e.getSelectedCells();return t.length&&e.copy(t),!1}),e.bindKey(["meta+x","ctrl+x"],()=>{const t=e.getSelectedCells();return t.length&&e.cut(t),!1}),e.bindKey(["meta+v","ctrl+v"],()=>{if(!e.isClipboardEmpty()){const t=e.paste({offset:32});e.cleanSelection(),e.select(t)}return!1}),e.bindKey(["meta+z","ctrl+z"],()=>(e.canUndo()&&e.undo(),!1)),e.bindKey(["meta+shift+z","ctrl+shift+z"],()=>(e.canRedo()&&e.redo(),!1)),e.bindKey(["meta+a","ctrl+a"],()=>{const t=e.getNodes();t&&e.select(t)}),e.bindKey("backspace",()=>{const t=e.getSelectedCells();t.length&&e.removeCells(t)})}function ge(e){const t=(l,a)=>{for(let n=0,d=l.length;n<d;n+=1)l[n].style.visibility=a?"visible":"hidden"};return e.on("node:mouseenter",()=>{const a=document.getElementById(e.container.id).querySelectorAll(".x6-port-body");t(a,!0)}),e.on("node:mouseleave",()=>{const a=document.getElementById(e.container.id).querySelectorAll(".x6-port-body");t(a,!1)}),{groups:{top:{position:"top",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},right:{position:"right",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},bottom:{position:"bottom",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},left:{position:"left",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}}},items:[{group:"top"},{group:"right"},{group:"bottom"},{group:"left"}]}}function we(e,t){const l=new ne({title:"流程图",target:e,stencilGraphWidth:120,collapsable:!0,groups:[{title:"节点列表",name:"group1",collapsable:!0}],layoutOptions:{columns:1,columnWidth:100,rowHeight:55}});return document.getElementById(t).appendChild(l.container),l}function he(e){return new x({container:document.getElementById(e),width:"100%",height:"100%",grid:!0,panning:!0,connecting:{router:"manhattan",connector:{name:"rounded",args:{radius:8}},anchor:"center",connectionPoint:"anchor",allowBlank:!1,snap:{radius:20},createEdge(){return new le({attrs:{line:{stroke:"#A2B1C3",strokeWidth:2,targetMarker:{name:"block",width:12,height:8}}},zIndex:0})},validateConnection({targetMagnet:t}){return!!t}},highlighting:{magnetAdsorbed:{name:"stroke",args:{attrs:{fill:"#5F95FF",stroke:"#5F95FF"}}}}})}const ve={__name:"WorkflowNodeForm",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(e){const t=se(e,"modelValue"),l=f();return(a,n)=>{const d=N("ElInput"),p=N("ElFormItem"),V=N("ElForm");return _(),K(V,{size:"small",ref_key:"formRef",ref:l,model:t.value,"label-position":"top"},{default:i(()=>[r(p,{label:"节点类型"},{default:i(()=>[r(d,{disabled:"",modelValue:t.value.nodeType,"onUpdate:modelValue":n[0]||(n[0]=c=>t.value.nodeType=c)},null,8,["modelValue"])]),_:1}),r(p,{label:"节点类型名称"},{default:i(()=>[r(d,{disabled:"",modelValue:t.value.nodeTypeName,"onUpdate:modelValue":n[1]||(n[1]=c=>t.value.nodeTypeName=c)},null,8,["modelValue"])]),_:1}),r(p,{label:"节点标识"},{default:i(()=>[r(d,{disabled:"",modelValue:t.value.nodeKey,"onUpdate:modelValue":n[2]||(n[2]=c=>t.value.nodeKey=c)},null,8,["modelValue"])]),_:1}),r(p,{label:"节点名称"},{default:i(()=>[r(d,{modelValue:t.value.nodeName,"onUpdate:modelValue":n[3]||(n[3]=c=>t.value.nodeName=c)},null,8,["modelValue"])]),_:1}),t.value.nodePropertiesFormMetaData?(_(),K(re,{key:0,size:"small","form-meta-data":t.value.nodePropertiesFormMetaData,modelValue:t.value.nodeProperties,"onUpdate:modelValue":n[4]||(n[4]=c=>t.value.nodeProperties=c)},null,8,["form-meta-data","modelValue"])):I("",!0)]),_:1},8,["model"])}}},be={style:{height:"10%"}},ke=v("div",null,[k(" 从左侧面板拖拽出节点放置到右侧画布上，鼠标悬停于节点上将显示连接桩(节点边缘的小圆圈)， 点击连接桩(按住鼠标左键)拖出线条进行连线，连接完成后松开鼠标左键。"),v("br"),k(" 可点击某个节点以修改其属性。"),v("br"),k(" 快捷键：ctrl+c复制，ctrl+v粘贴，ctrl+x剪切，backspace删除，ctrl+z撤销，ctrl+shift+z重做，ctrl+a全选 ")],-1),Fe="workflow-main-container",B="workflow-stencil-container",M="workflow-graph-container",U={__name:"WorkflowEditor",props:{workflow:{required:!1}},setup(e,{expose:t}){const l=e,a=ae();let n;de(()=>{n=me(B,M),n.on("node:added",({node:o})=>c(o)),n.on("node:click",({node:o})=>S(o)),n.on("cell:mouseenter",({cell:o})=>V(o)),n.on("cell:mouseleave",({cell:o})=>{o.removeTool("button-remove")}),l.workflow&&d()});async function d(){y.value.workflowName=l.workflow.name;const o=await A({}).then(u=>u.nodeTypes),s={nodes:[],edges:[]};for(let u of l.workflow.nodes){a.addSequence(u.nodeKey),a.addSequence(u.nodeName);const T=o.find($=>u.nodeType===$.nodeType),g={nodeType:T.nodeType,nodeTypeName:T.nodeTypeName,nodePropertiesFormMetaData:T.nodePropertiesFormMetaData,nodeKey:u.nodeKey,nodeName:u.nodeName,nodeProperties:u.nodeProperties};s.nodes.push({id:g.nodeKey,shape:"custom-rect",label:g.nodeName,data:g,attrs:{body:{rx:10,ry:10}},ports:{items:[{group:"top",id:g.nodeKey+"-top"},{group:"right",id:g.nodeKey+"-right"},{group:"bottom",id:g.nodeKey+"-bottom"},{group:"left",id:g.nodeKey+"-left"}]}})}for(let u of l.workflow.sequenceFlows)s.edges.push({shape:"edge",source:{cell:u.sourceNodeKey,port:u.sourceNodeKey+"-bottom"},target:{cell:u.targetNodeKey,port:u.targetNodeKey+"-top"},attrs:{line:{stroke:"#A2B1C3",strokeWidth:2,targetMarker:{name:"block",width:12,height:8}}},zIndex:0});const m=new R({nodesep:20,ranksep:20}).layout(s);n.fromJSON(m)}function p(){fe(n)}function V(o){o.addTools([{name:"button-remove"}])}function c(o){if(o.data.nodeKey!==o.id){const s=a.getSequence(o.getData().nodeTypeName),h=a.getSequence(o.getData().nodeType);o.label=s,o.updateData({nodeName:s,nodeKey:h})}}const E=f(),b=f();function S(o){E.value=o,b.value=o.data}ie(()=>{var o;return(o=b.value)==null?void 0:o.nodeName},()=>{var o;(o=b.value)!=null&&o.nodeName&&(E.value.label=b.value.nodeName)});const y=f({});function C(o,s){return o.find(h=>h.id===s)}function D(){var s,h;const o=n.toJSON();y.value.nodes=[],y.value.sequenceFlows=[];for(let m of o.cells)m.shape==="edge"?y.value.sequenceFlows.push({sourceNodeKey:(s=C(o.cells,m.source.cell))==null?void 0:s.data.nodeKey,targetNodeKey:(h=C(o.cells,m.target.cell))==null?void 0:h.data.nodeKey}):y.value.nodes.push({nodeType:m.data.nodeType,nodeKey:m.data.nodeKey,nodeName:m.data.nodeName,nodeProperties:m.data.nodeProperties})}function z(){return D(),L(y.value)}function w(){if(!l.workflow){console.error("Current workflow is undefined, cannot update.");return}D();const o={...y.value,workflowId:l.workflow.id};return H(o)}return t({confirmCreate:z,confirmUpdate:w}),(o,s)=>{const h=N("ElInput"),m=N("ElButton"),u=N("ElTooltip"),T=N("ElCard");return _(),O(G,null,[v("div",be,[r(h,{style:{width:"150px","margin-right":"50px"},modelValue:y.value.workflowName,"onUpdate:modelValue":s[0]||(s[0]=g=>y.value.workflowName=g),placeholder:"请输入流程名称"},null,8,["modelValue"]),r(m,{onClick:p},{default:i(()=>[k("自动布局")]),_:1}),r(u,null,{content:i(()=>[ke]),default:i(()=>[r(m,{link:"",icon:"Warning"},{default:i(()=>[k("操作说明")]),_:1})]),_:1}),E.value?(_(),K(T,{key:0,style:{position:"absolute",top:"80px",right:"30px",width:"260px","background-color":"#07070e","z-index":"9999"}},{default:i(()=>[r(ve,{modelValue:b.value,"onUpdate:modelValue":s[1]||(s[1]=g=>b.value=g)},null,8,["modelValue"])]),_:1})):I("",!0)]),v("div",{style:{width:"100%",height:"90%"}},[v("div",{id:Fe},[v("div",{id:B}),v("div",{id:M})])])],64)}}},Ne={style:{"margin-bottom":"10px",height:"32px"}},Me={__name:"Workflow",setup(e){const t=f(),l=f(!1),a=f(!1),n=f([]),d=f({}),p=f();function V(w){n.value=w}function c(){return n.value.map(w=>w.id)}function E(){l.value=!0}function b(){n.value.length===1&&(p.value=n.value[0],a.value=!0)}const S=f();function y(){S.value.confirmCreate().then(w=>{l.value=!1,t.value.fetchData()})}const C=f();function D(){C.value.confirmUpdate().then(w=>{a.value=!1,t.value.fetchData()})}function z(){const o={workflowIds:c()};X(o).then(s=>{t.value.fetchData()})}return(w,o)=>(_(),O(G,null,[v("div",Ne,[r(q,{type:"primary",onClick:E},{default:i(()=>[k(" 创建 ")]),_:1}),r(q,{disabled:n.value.length!==1,"disabled-message":"请选择且只选择一项",onClick:b},{default:i(()=>[k(" 编辑 ")]),_:1},8,["disabled"]),r(F(ue),{title:"确认删除",onConfirm:z},{reference:i(()=>[r(q,{disabled:n.value.length===0,type:"danger",plain:""},{default:i(()=>[k(" 删除 ")]),_:1},8,["disabled"])]),_:1}),r(F(ce),{style:{float:"right",width:"20%"},modelValue:d.value.search,"onUpdate:modelValue":o[0]||(o[0]=s=>d.value.search=s),"suffix-icon":"search"},null,8,["modelValue"])]),r(J,{ref_key:"tableRef",ref:t,"paging-request":d.value,"remote-method":F(Y),onSelectionChange:V},{default:i(()=>[r(F(W),{type:"selection","reserve-selection":""}),r(F(W),{prop:"name",label:"名称",sortable:"custom"}),r(F(W),{prop:"createdAt",label:"创建时间",sortable:"custom"}),r(F(W),{prop:"lastModifiedAt",label:"更新时间",sortable:"custom"})]),_:1},8,["paging-request","remote-method"]),r(P,{modelValue:l.value,"onUpdate:modelValue":o[1]||(o[1]=s=>l.value=s),title:"创建流程",onOnConfirm:y,size:"1000"},{default:i(()=>[l.value?(_(),K(U,{key:0,ref_key:"createEditorRef",ref:S},null,512)):I("",!0)]),_:1},8,["modelValue"]),r(P,{modelValue:a.value,"onUpdate:modelValue":o[2]||(o[2]=s=>a.value=s),title:"编辑流程",onOnConfirm:D,size:"1000"},{default:i(()=>[a.value?(_(),K(U,{key:0,ref_key:"updateEditorRef",ref:C,workflow:p.value},null,8,["workflow"])):I("",!0)]),_:1},8,["modelValue"])],64))}};export{Me as default};
