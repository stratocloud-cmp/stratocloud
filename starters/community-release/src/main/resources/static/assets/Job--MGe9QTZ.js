import{_ as ee}from"./StratoTable-CDLvuijz.js";import{d as te,r as ae}from"./job-D_aeKnDK.js";import{u as ne}from"./request-BLvKnTIl.js";import{A as R,n as s,o,b as g,e,w as t,d as p,u as E,a2 as le,a3 as oe,q as c,I as se,t as z,r as b,v as w,F as A,f as ie,i as j,B as F,x as re,ae as ue}from"./index-CGSAaZ7c.js";import{d as de}from"./asyncJob-BQqx-GkL.js";import{_ as me}from"./StratoDrawer-SANI4yOp.js";import"./StratoButton-BbyvpoLv.js";const ce=["innerHTML"],pe={style:{"margin-left":"6px"}},fe={__name:"JobStatus",props:{state:{required:!0},errorMessage:{required:!1},size:{required:!1}},setup(i){const T=i,C={AWAIT_START:{name:"等待",icon:"Clock",type:"info"},STARTED:{name:"已开始",icon:"Loading",type:"primary"},FINISHED:{name:"执行成功",icon:"Check",type:"success"},FAILED:{name:"失败",icon:"Warning",type:"danger"},CANCELED:{name:"已取消",icon:"Close",type:"warning"}},u=R(()=>{let m=C[T.state];return m===void 0&&(m={name:T.state,icon:"QuestionFilled",type:"warning"}),m});return(m,I)=>{const h=s("ElTooltip"),v=s("ElText");return o(),g("span",null,[e(v,{style:{cursor:"pointer"},type:u.value.type},{default:t(()=>[e(h,{disabled:i.state!=="FAILED"},{content:t(()=>[p("div",{style:{"max-width":"500px","white-space":"pre-wrap","max-height":"400px",overflow:"auto"},innerHTML:i.errorMessage},null,8,ce)]),default:t(()=>[e(E(le),{class:oe(u.value.icon==="Loading"?"is-loading":"")},{default:t(()=>[(o(),c(se(u.value.icon)))]),_:1},8,["class"])]),_:1},8,["disabled"])]),_:1},8,["type"]),p("span",pe,z(u.value.name),1)])}}},ye={style:{"margin-bottom":"10px",height:"32px"}},_e={key:0},be=p("span",{style:{"font-size":"12px"}}," 查看详情 ",-1),ge=["innerHTML"],Ie={__name:"Job",props:{simpleMode:{required:!1,type:Boolean,default:!1},myJob:{required:!1,type:Boolean,default:!1}},setup(i,{expose:T}){const C=ne(),u=i,m=b();T({refresh:I});function I(){return m.value.fetchData()}const h=b({ownerIds:u.myJob?[C.session.userId]:void 0}),v=b(new Map);function $(l){if(l&&l.length>0){const d=l.map(a=>a.id);de({jobIds:d,size:100}).then(a=>{if(a!=null&&a.content&&a.content.length>0)for(let y of a.content)v.value.set(y.id,y)})}}function H(l){return v.value.has(l)}const x=b(!1);function W(l){f.value=l,x.value=!0}const f=b(),U=R(()=>{if(f.value)return v.value.get(f.value.id)}),D=[{id:"AWAIT_START",name:"待开始",type:"info"},{id:"STARTED",name:"已开始",type:"primary"},{id:"FAILED",name:"已失败",type:"danger"},{id:"FINISHED",name:"已完成",type:"success"},{id:"DISCARDED",name:"已废弃",type:"warning"},{id:"CANCELED",name:"已取消",type:"warning"}],O=D,Q=D;function L(l,d){let a=d.find(y=>y.id===l);return a||(a={id:l,name:l,type:"warning"}),a}const M=b(!1);function G(l){M.value=!0,ae({jobId:l.id}).then(()=>{I(),re.success("重试请求已提交")}).finally(()=>{M.value=!1})}return(l,d)=>{var V;const a=s("ElTableColumn"),y=s("ElLink"),K=s("ElButton"),r=s("ElTimelineItem"),P=s("ElIcon"),X=s("ElTooltip"),S=s("ElTimeline"),N=s("ElCollapseItem"),q=s("ElCollapse");return o(),g(A,null,[p("div",ye,[u.myJob?(o(),g("span",_e,"我的任务")):w("",!0),e(E(ie),{style:{float:"right",width:"20%"},modelValue:h.value.search,"onUpdate:modelValue":d[0]||(d[0]=n=>h.value.search=n),"suffix-icon":"search"},null,8,["modelValue"])]),e(ee,{ref_key:"jobTableRef",ref:m,size:i.simpleMode?"small":"default","default-page-size":i.simpleMode?5:10,"paging-request":h.value,"remote-method":E(te),onListChange:$},{default:t(()=>[i.simpleMode?w("",!0):(o(),c(a,{key:0,type:"selection","reserve-selection":""})),e(a,{prop:"jobTypeName",label:"类型",sortable:"custom"}),e(a,{prop:"status",label:"状态",sortable:"custom"},{default:t(n=>[e(fe,{size:u.simpleMode?"small":"default",state:n.row.status,"error-message":n.row.errorMessage},null,8,["size","state","error-message"])]),_:1}),e(a,{prop:"createdAt",label:"创建时间",sortable:"custom"}),e(a,{prop:"startedAt",label:"开始时间",sortable:"custom"}),e(a,{prop:"endedAt",label:"结束时间",sortable:"custom"}),i.simpleMode?w("",!0):(o(),c(a,{key:1,label:"详情",width:"120"},{default:t(n=>[e(y,{type:"primary",disabled:!H(n.row.id),onClick:()=>W(n.row)},{default:t(()=>[be]),_:2},1032,["disabled","onClick"])]),_:1})),e(a,{label:"操作",width:"80"},{default:t(n=>[e(K,{link:"",type:"primary",loading:M.value,disabled:n.row.status!=="FAILED",onClick:()=>G(n.row)},{default:t(()=>[j(" 重试 ")]),_:2},1032,["loading","disabled","onClick"])]),_:1})]),_:1},8,["size","default-page-size","paging-request","remote-method"]),e(me,{title:(V=f.value)==null?void 0:V.jobTypeName,modelValue:x.value,"onUpdate:modelValue":d[1]||(d[1]=n=>x.value=n),size:"800","no-confirm":""},{default:t(()=>[e(S,null,{default:t(()=>{var n,B;return[e(r,{timestamp:(n=f.value)==null?void 0:n.startedAt,placement:"top"},null,8,["timestamp"]),(o(!0),g(A,null,F(U.value.executions,(k,Y)=>(o(),c(r,{type:L(k.state,D).type,timestamp:k.lastModifiedAt,placement:"top"},{default:t(()=>[e(q,null,{default:t(()=>[e(N,{title:`执行${Y+1}`},{default:t(()=>[e(S,null,{default:t(()=>[e(r),(o(!0),g(A,null,F(k.steps,(J,Z)=>(o(),c(r,{type:L(J.state,E(O)).type,timestamp:J.lastModifiedAt,placement:"top"},{default:t(()=>[e(q,null,{default:t(()=>[e(N,{title:`步骤${Z+1}`},{default:t(()=>[e(S,null,{default:t(()=>[e(r),(o(!0),g(A,null,F(J.tasks,_=>(o(),c(r,{type:L(_.state,E(Q)).type,timestamp:_.lastModifiedAt,placement:"top"},{default:t(()=>[p("div",null,[j(z(_.name)+" ",1),_.message?(o(),c(X,{key:0},{content:t(()=>[p("div",{style:{"max-width":"500px","white-space":"pre-wrap","max-height":"300px",overflow:"auto"},innerHTML:_.message},null,8,ge)]),default:t(()=>[e(P,null,{default:t(()=>[e(E(ue))]),_:1})]),_:2},1024)):w("",!0)]),p("div",null,z(_.entityDescription),1)]),_:2},1032,["type","timestamp"]))),256)),e(r)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1024)]),_:2},1032,["type","timestamp"]))),256)),e(r)]),_:2},1024)]),_:2},1032,["title"])]),_:2},1024)]),_:2},1032,["type","timestamp"]))),256)),e(r,{timestamp:(B=f.value)==null?void 0:B.endedAt,placement:"top"},null,8,["timestamp"])]}),_:1})]),_:1},8,["title","modelValue"])],64)}}};export{Ie as default};
